(function(){try{"use strict";var n=window.$MicrosoftMaps8,t=n.Internal,i=n.GlobalConfig,e=n.CommonControls.SearchBoxAutosuggestDataModel,o=n.CommonControls.DirectionsAutosuggestDataModel,v=n.CommonControls.AutosuggestViewModel,y=n.CommonControls.AutosuggestV2,p=n.CommonControls.SuggestionViewModelV2,u=n.Module,s=n.Location,nt=t._Network,tt=t.MapHelper,w=n.GlobalConfig.features.autosuggest,it=t._ObservableObject,r=t._JSEvent,h=n.Search.Address,c=n.LocationRect,f=t._Gimme,b=t._MapAuthentication,k=t.GeolocationProvider,d=n.ResourceManager.CommonControls,g=function(){function n(n){this._disposables=[];this._setDefaultOptions();this.setOptions(n);this._controlTemplateFactory=u&&u.container&&u.container.instance&&u.container.instance("ControlTemplateFactory");this._autoSuggestModel=n&&n.serpOptions?new o(n.serpOptions):new e;this._geolocationProvider=new k(window,null);this.invalidated=new r}return n.prototype.setOptions=function(n){var t,i,r;if(n)n.map?this._map=n.map.getV8Map?n.map.getV8Map():n.map:this._map&&n.map===null&&(this._map=null),t=this._options,t.map=n.map!==undefined?this._getCoreMapInstance(n.map):t.map,t.maxResults=typeof n.maxResults=="number"&&n.maxResults%1==0?n.maxResults:t.maxResults,t.useMapView=typeof n.useMapView=="boolean"?n.useMapView:t.useMapView,t.autoDetectLocation=typeof n.autoDetectLocation=="boolean"?n.autoDetectLocation:t.autoDetectLocation,t.placeSuggestions=typeof n.placeSuggestions=="boolean"?n.placeSuggestions:t.placeSuggestions,t.addressSuggestions=typeof n.addressSuggestions=="boolean"?n.addressSuggestions:t.addressSuggestions,t.businessSuggestions=typeof n.businessSuggestions=="boolean"?n.businessSuggestions:t.businessSuggestions,t.userLocation=n.userLocation!==undefined?n.userLocation:t.userLocation,t.bounds=n.bounds!==undefined?n.bounds:t.bounds,t.showBingLogo=typeof n.showBingLogo=="boolean"?n.showBingLogo:t.showBingLogo,t.countryCode=typeof n.countryCode=="string"&&n.countryCode.length===2?n.countryCode:t.countryCode,n.serpOptions&&(i=n.serpOptions,r=t.serpOptions||{},r.suggestionTypes=i.suggestionTypes?i.suggestionTypes:r.suggestionTypes,r.showHistorySuggestions=typeof i.showHistorySuggestions=="boolean"?i.showHistorySuggestions:r.showHistorySuggestions,r.showMyLocation=typeof i.showMyLocation=="boolean"?i.showMyLocation:r.showMyLocation,r.prevWaypoint=i.prevWaypoint!==undefined?i.prevWaypoint:r.prevWaypoint,r.dirMode=i.dirMode!==undefined?i.dirMode:r.dirMode,r.appId=i.appId!==undefined?i.appId:r.appId,r.maxHistoryWaypoints=typeof i.maxHistoryWaypoints=="number"?i.maxHistoryWaypoints:r.maxHistoryWaypoints,r.selectFirstOnEnter=typeof i.selectFirstOnEnter=="boolean"?i.selectFirstOnEnter:r.selectFirstOnEnter,i.width!==undefined&&(r.width=i.width,this._autosuggestViewModel&&this._autosuggestViewModel.setWidth(i.width)),t.serpOptions=r,this._autoSuggestModel&&this._autoSuggestModel.updateOptions(r));else return},n.prototype.getOptions=function(){return this._options},n.prototype.getSuggestions=function(n,t){var r=this,i;this._autoSuggestModel=this._autoSuggestModel||this._options&&this._options.serpOptions&&new o||new e;n&&t&&(i={searchText:n,userLocation:null,localMapView:null},this._updateSuggestionRequestWithOptions(i),this._validateCredentials(function(){r._autoSuggestModel.getSuggestions(i,function(i){var u=r._parseSuggestions(i);t(u,n)})}))},n.prototype._setFocusCallback=function(n){this._focusCallback=n},n.prototype.attachAutosuggest=function(t,i,u){var s=this,h,c,l,a,p;if(this.detachAutosuggest(),t===i||!i||!t)throw new Error("For attaching autosuggest make sure distinct valid ids are provided for suggestionBoxId and suggestionContainerId");if(h=f(t),this._searchBoxDomElement=h&&h.length>0?h[0]:null,!this._searchBoxDomElement||this._searchBoxDomElement.tagName.toUpperCase()!=="INPUT"||this._searchBoxDomElement.type.toUpperCase()!=="TEXT"&&this._searchBoxDomElement.type.toUpperCase()!=="SEARCH")throw new Error("Can attach Autosuggest only to a valid input text type element");if(c=f(i),!c||c.length===0)throw new Error("Invalid suggestionContainerId: "+i);l=f(document.createElement("div"));l.add_class("MicrosoftMap");l.set_style({position:"absolute"});a=h.get_sibling(1);p=a.length>0&&a.getParent();a.length&&p&&p.length>0&&p[0]===c[0]?c.insertBefore(l,a):c.append(l);this._selectedSuggestionCallback=u;this._searchBoxDomElement[n._searchBoxInstanceId]&&this._searchBoxDomElement[n._searchBoxInstanceId].detachAutosuggest();this._searchBoxDomElement[n._searchBoxInstanceId]=this;this._suggestionItemClicked=new r;this._disposables.push(this._suggestionItemClicked.add(function(n){s._onSuggestionItemSelected(n)}));this._onAutosuggestKeydown=new r;this._disposables.push(this._onAutosuggestKeydown.add(function(n){s._onAutosuggestKeydownFunction(n)}));this._focusHandler=new r;this._disposables.push(this._focusHandler.add(function(n){s._handleFocus(n)}));this._visibilityChangedEvent=new r;this._visibilityChangedEvent.add(function(n){s._setAsExpanded(n)});this._selectionChangedEvent=new r;this._selectionChangedEvent.add(function(n){s._setSelectedSuggestionId(n)});this._suggestionRequestHandler=new r;this._disposables.push(this._suggestionRequestHandler.add(function(n){s._onSuggestionRequested(n)}));this._autoSuggestModel=this._autoSuggestModel||this._options&&this._options.serpOptions&&new o(this._options.serpOptions)||new e;this._autosuggestViewModel=new v(this._autoSuggestModel,this._controlTemplateFactory,!0,null,this._visibilityChangedEvent,this._selectionChangedEvent);this._autosuggestViewModel.setShowBingLogo(this._options.showBingLogo);this._options.serpOptions&&this._autosuggestViewModel.setWidth(this._options.serpOptions.width);this._autosuggest=new y(l,h,"as_container_search",this._autosuggestViewModel,this._map,!0);this._autosuggest.setAutosuggestKeydownHandler(this._onAutosuggestKeydown);this._autosuggest.setItemClickEventHandler(this._suggestionItemClicked);this._autosuggest.setFocusEventHandler(this._focusHandler);this._autosuggest.setSuggestionRequestHandler(this._suggestionRequestHandler);this._searchBoxDomElement.setAttribute("aria-controls",this._autosuggestViewModel.getId());this._searchBoxDomElement.setAttribute("aria-owns",this._autosuggestViewModel.getId());this._searchBoxDomElement.setAttribute("aria-expanded","false");this._searchBoxDomElement.setAttribute("aria-autocomplete","both");this._searchBoxDomElement.setAttribute("type","search");f(this._searchBoxDomElement).set_style({"box-sizing":"content-box"})},n.prototype.detachAutosuggest=function(){for(var t=0,i=this._disposables.length;t<i;t++)this._disposables[t].dispose();this._autosuggest&&(this._autosuggest.stopAutosuggest(),this._autosuggest.removeEventHandlers());this._autosuggest=null;this._autoSuggestModel=null;this._autosuggestViewModel=null;this._suggestionItemClicked=null;this._onAutosuggestKeydown=null;this._focusHandler=null;this._suggestionRequestHandler=null;this._searchBoxDomElement&&(this._searchBoxDomElement.removeAttribute("aria-controls"),this._searchBoxDomElement.removeAttribute("aria-owns"),this._searchBoxDomElement.removeAttribute("aria-expanded"),this._searchBoxDomElement.removeAttribute("aria-autocomplete"),this._searchBoxDomElement.removeAttribute("aria-activedescendant"),this._searchBoxDomElement[n._searchBoxInstanceId]=null,this._searchBoxDomElement=null)},n.prototype._validateCredentials=function(n){b.instance.authenticateClientAndRetrieveSessionId(n,function(){throw new Error("Missing/Invalid Credentials. Either provide a map instance or set the Credentials in LoadModule API");})},n.prototype.dispose=function(){this.detachAutosuggest();this._options=null;this._map=null},n.prototype._onSuggestionRequested=function(n){this._currentSearchTerm&&this._currentSearchTerm!==n.searchText&&(this._currentSearchTerm=null,this.invalidated.invoke());this._updateSuggestionRequestWithOptions(n)},n.prototype._updateSuggestionRequestWithOptions=function(n){n.disableThisRequest=!1;n.localMapView=this._getMapViewPort();n.userLocation=this._getUserLocation();n.suggestionTypes=this._getSuggestionTypes();n.maxResults=this._options.maxResults;n.applicationName="MapsSdkV8";n.applicationId=this._options.serpOptions&&this._options.serpOptions.appId||w.sdkAutosuggestAppid;n.market=i.dynamicProperties.market;n.countryCode=this._options.countryCode;n.disableFavorites=i.isSDK?!0:!1;n.disableHistory=i.isSDK?!0:!1;n.suggestionTypes&&n.maxResults!==0||(n.disableThisRequest=!0)},n.prototype._handleFocus=function(n){this._focusCallback&&this._focusCallback(n);n&&this._autosuggest&&this._autosuggest.refreshAutosuggest()},n.prototype._onAutosuggestKeydownFunction=function(n){var i=n,r=i.keyCode||i.which,t;r===13&&(this._autosuggestViewModel&&(t=this._autosuggestViewModel.getSelectedSuggestion()),!t&&this._options&&this._options.serpOptions&&this._options.serpOptions.selectFirstOnEnter&&(t=this._autosuggestViewModel.getFirstSuggestion()),t&&this._onSuggestionItemSelected(t))},n.prototype._onSuggestionItemSelected=function(n){var t=this,i;n&&n.searchText===d.L_MyLocation?(i={callback:function(i){return t._onGeolocationProviderCallback(i,n)},performReverseGeocoding:!1},this._geolocationProvider.GetCurrentPosition(i)):this._geocoder?this._geocodeSuggestion(n):this._validateCredentials(function(){u.container.instanceAsync("Geocoder",function(i){t._geocoder=i;t._geocodeSuggestion(n)})})},n.prototype._onGeolocationProviderCallback=function(n,t){var r,u;n.error?i.dynamicProperties.reverseIPLocation&&(r=i.dynamicProperties.reverseIPLocation.split(","),t.location=new s(r[0],r[1])):t.location=n.location;t.location&&(u=this._getSuggestionResult(t),this._onSelectedSuggestionReady(u))},n.prototype._geocodeSuggestion=function(n){var i=this,t=this._getSuggestionResult(n),r=this._getSuggestionAddress(n);this._geocoder.geocode(r,function(n){var r,u,f;n.success&&n.results&&n.results.length>0&&(r=n.results[0],u=r.bbox,!t.location&&r.point&&(f=r.point.coordinates,t.location=new s(f[0],f[1])),u&&u.length===4&&(t.bestView=c.fromEdges(u[2],u[1],u[0],u[3])),t.address&&!t.address.adminDistrict&&r.address&&r.address.adminDistrict&&(t.address.adminDistrict=r.address.adminDistrict));i._onSelectedSuggestionReady(t)},null,1)},n.prototype._onSelectedSuggestionReady=function(n){this._selectedSuggestionCallback&&this._selectedSuggestionCallback(n);this._autosuggest&&this._autosuggest.stopAutosuggest();this._updateSearchBox(n.formattedSuggestion)},n.prototype._updateSearchBox=function(n){this._currentSearchTerm=n;var t=f(this._searchBoxDomElement);t&&t.set_attr("value",n)},n.prototype._parseSuggestions=function(n){var r=[],i=n.suggestions,t;if(i.length>0)for(t=0;t<i.length;t++)r.push(this._getSuggestionResult(i[t]));return r},n.prototype._getSuggestionResult=function(n){return new l(new p(n))},n.prototype._setDefaultOptions=function(){this._options={maxResults:5,useMapView:!0,addressSuggestions:!0,autoDetectLocation:!0,placeSuggestions:!0,businessSuggestions:!1,showBingLogo:!0,countryCode:""}},n.prototype._getSuggestionTypes=function(){var n=this._options,t=[];return n.serpOptions&&n.serpOptions.suggestionTypes?n.serpOptions.suggestionTypes:(n.placeSuggestions&&t.push("place"),n.addressSuggestions&&t.push("address"),n.businessSuggestions&&t.push("business"),t.join(","))},n.prototype._getMapViewPort=function(){var t=this._map,n=this._options.bounds?this._options.bounds:this._options.useMapView&&t?t.getBounds(!1):null,i;return n?(this._validateBoundingBox(n),i=[n.getNorth(),n.getWest(),n.getSouth(),n.getEast()],i.join(",")):""},n.prototype._getUserLocation=function(){var t="",n=this._options.userLocation;return n?(this._validateLocation(n),t=n.latitude+","+n.longitude+",100"):i.dynamicProperties.reverseIPLocation&&this._options.autoDetectLocation&&(t=i.dynamicProperties.reverseIPLocation+",100"),t},n.prototype._getCoreMapInstance=function(n){return n?n.getV8Map?n.getV8Map():n:null},n.prototype._validateLocation=function(n){if(n)var t=new s(n.latitude,n.longitude)},n.prototype._validateBoundingBox=function(n){if(n)var t=c.fromLocations(n.getNorthwest(),n.getSoutheast())},n.prototype._getSuggestionAddress=function(n){return n&&n.type==="LocalBusiness"&&n.formatedAddress?n.formatedAddress:n&&n.searchText},n.prototype._setAsExpanded=function(n){this._searchBoxDomElement.setAttribute("aria-expanded",n?"true":"false")},n.prototype._setSelectedSuggestionId=function(n){this._searchBoxDomElement.setAttribute("aria-activedescendant",n)},n._searchBoxInstanceId="$bingmaps_As",n}(),l=function(){function n(n){var t,i;n&&(t=n.suggestion,t&&(this.subtitle=t.formatedAddress,this.location=t.location,this.entityType=t.type,this.entitySubType=t.subType,this.title=t.title,this.entityId=t.entityId||t.geoId,(t.address||t.root)&&(this.address=new h(null),i=t.address||t.root,this.address.countryRegionISO2=i.countryIso,this.address.adminDistrict=i.addressRegion,this.address.district=i.addressSubregion,this.address.addressLine=i.streetAddress,this.address.countryRegion=i.addressCountry,this.address.locality=i.addressLocality,this.address.postalCode=i.postalCode,this.address.countryRegion||this.address.adminDistrict||this.address.locality||this.address.district||this.address.countryRegionISO2||(this.address=null)),this.formattedSuggestion=t.searchText||this.title||this.subtitle,this.address&&(this.address.formattedAddress=this.formattedSuggestion),t.type==="LocalBusiness"&&(this.location=null,this.YPID=t.entityId)))}return n}();n.AutosuggestManager=g;n.SuggestionResult=l;n.Address=h}catch(a){if(n.logger)n.logger.logCriticalError(a);else throw a;}}).call(window)